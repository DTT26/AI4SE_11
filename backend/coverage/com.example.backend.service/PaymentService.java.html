<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="vi"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PaymentService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">backend</a> &gt; <a href="index.source.html" class="el_package">com.example.backend.service</a> &gt; <span class="el_source">PaymentService.java</span></div><h1>PaymentService.java</h1><pre class="source lang-java linenums">package com.example.backend.service;

import com.example.backend.dto.PaymentDTO;
import com.example.backend.mapper.PaymentMapper;
import com.example.backend.model.Appointment;
import com.example.backend.model.Payment;
import com.example.backend.repository.AppointmentRepository;
import com.example.backend.repository.PaymentRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.Optional;

@Service
@RequiredArgsConstructor
<span class="nc" id="L21">@Slf4j</span>
public class PaymentService {
    
    private final PaymentRepository paymentRepository;
    private final AppointmentRepository appointmentRepository;
    private final PayOSService payOSService;
    private final PaymentMapper paymentMapper;
    
    @Transactional
    public PaymentDTO.Response createPayment(PaymentDTO.Create paymentCreateDTO) {
        try {
<span class="nc" id="L32">            log.info(&quot;üîç Creating payment for appointment ID: {}&quot;, paymentCreateDTO.getAppointmentId());</span>
<span class="nc" id="L33">            log.info(&quot;üîç Payment DTO: {}&quot;, paymentCreateDTO);</span>
            
            // Ki·ªÉm tra appointment c√≥ t·ªìn t·∫°i kh√¥ng
<span class="nc" id="L36">            Optional&lt;Appointment&gt; appointmentOpt = appointmentRepository.findById(paymentCreateDTO.getAppointmentId());</span>
<span class="nc bnc" id="L37" title="All 2 branches missed.">            if (appointmentOpt.isEmpty()) {</span>
<span class="nc" id="L38">                log.error(&quot;‚ùå Appointment not found with ID: {}&quot;, paymentCreateDTO.getAppointmentId());</span>
<span class="nc" id="L39">                throw new RuntimeException(&quot;Kh√¥ng t√¨m th·∫•y l·ªãch h·∫πn v·ªõi ID: &quot; + paymentCreateDTO.getAppointmentId());</span>
            }
            
<span class="nc" id="L42">            Appointment appointment = appointmentOpt.get();</span>
<span class="nc" id="L43">            log.info(&quot;‚úÖ Found appointment: ID={}, Fee={}&quot;, appointment.getAppointmentId(), appointment.getFee());</span>
            
            // Ki·ªÉm tra xem ƒë√£ c√≥ payment cho appointment n√†y ch∆∞a
<span class="nc" id="L46">            List&lt;Payment&gt; existingPayments = paymentRepository.findByAppointment_AppointmentId(paymentCreateDTO.getAppointmentId());</span>
<span class="nc bnc" id="L47" title="All 2 branches missed.">            Optional&lt;Payment&gt; existingPayment = existingPayments.isEmpty() ? Optional.empty() : Optional.of(existingPayments.get(0));</span>
<span class="nc bnc" id="L48" title="All 2 branches missed.">            if (existingPayment.isPresent()) {</span>
<span class="nc" id="L49">                Payment payment = existingPayment.get();</span>
<span class="nc bnc" id="L50" title="All 2 branches missed.">                if (payment.getStatus() == Payment.PaymentStatus.PENDING) {</span>
                    // N·∫øu payment ƒëang pending, t·∫°o l·∫°i link thanh to√°n
<span class="nc" id="L52">                    payOSService.createPaymentLink(</span>
                        payment, 
<span class="nc" id="L54">                        paymentCreateDTO.getReturnUrl(), </span>
<span class="nc" id="L55">                        paymentCreateDTO.getCancelUrl()</span>
                    );
                    
<span class="nc" id="L58">                    paymentRepository.save(payment);</span>
<span class="nc" id="L59">                    return paymentMapper.toResponseDTO(payment);</span>
<span class="nc bnc" id="L60" title="All 2 branches missed.">                } else if (payment.getStatus() == Payment.PaymentStatus.PAID) {</span>
<span class="nc" id="L61">                    throw new RuntimeException(&quot;L·ªãch h·∫πn n√†y ƒë√£ ƒë∆∞·ª£c thanh to√°n&quot;);</span>
<span class="nc bnc" id="L62" title="All 2 branches missed.">                } else if (payment.getStatus() == Payment.PaymentStatus.CANCELLED || </span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">                          payment.getStatus() == Payment.PaymentStatus.FAILED) {</span>
                    // N·∫øu payment ƒë√£ b·ªã h·ªßy ho·∫∑c th·∫•t b·∫°i, c·∫≠p nh·∫≠t l·∫°i th√†nh PENDING v√† t·∫°o link m·ªõi
<span class="nc" id="L65">                    log.info(&quot;üîÑ Reusing cancelled/failed payment for appointment ID: {}&quot;, paymentCreateDTO.getAppointmentId());</span>
                    
                    // Reset payment fields
<span class="nc" id="L68">                    payment.setStatus(Payment.PaymentStatus.PENDING);</span>
<span class="nc" id="L69">                    payment.setPayOSLink(null);</span>
<span class="nc" id="L70">                    payment.setPayOSPaymentId(null);</span>
<span class="nc" id="L71">                    payment.setPayOSCode(null);</span>
<span class="nc" id="L72">                    payment.setPaidAt(null);</span>
<span class="nc" id="L73">                    payment.setFailureReason(null);</span>
                    
                    // C·∫≠p nh·∫≠t amount t·ª´ appointment
<span class="nc bnc" id="L76" title="All 2 branches missed.">                    if (appointment.getFee() != null) {</span>
<span class="nc" id="L77">                        payment.setAmount(appointment.getFee());</span>
<span class="nc" id="L78">                        log.info(&quot;Updated payment amount from appointment fee: {} VND&quot;, appointment.getFee());</span>
                    }
                    
                    // C·∫≠p nh·∫≠t description
<span class="nc bnc" id="L82" title="All 2 branches missed.">                    payment.setDescription(paymentCreateDTO.getDescription() != null ? </span>
<span class="nc" id="L83">                        paymentCreateDTO.getDescription() : &quot;Thanh to√°n l·ªãch h·∫πn kh√°m b·ªánh&quot;);</span>
                    
                    // T·∫°o PayOS payment link m·ªõi
<span class="nc" id="L86">                    payOSService.createPaymentLink(</span>
                        payment,
<span class="nc" id="L88">                        paymentCreateDTO.getReturnUrl(),</span>
<span class="nc" id="L89">                        paymentCreateDTO.getCancelUrl()</span>
                    );
                    
<span class="nc" id="L92">                    payment = paymentRepository.save(payment);</span>
<span class="nc" id="L93">                    log.info(&quot;‚úÖ Reused payment with new PayOS link for payment ID: {}&quot;, payment.getPaymentId());</span>
<span class="nc" id="L94">                    return paymentMapper.toResponseDTO(payment);</span>
                }
            }
            
            // T·∫°o payment m·ªõi
<span class="nc" id="L99">            Payment payment = new Payment();</span>
<span class="nc" id="L100">            payment.setAppointment(appointment);</span>
            
            // L·∫•y fee t·ª´ appointment thay v√¨ t·ª´ DTO
<span class="nc bnc" id="L103" title="All 2 branches missed.">            if (appointment.getFee() != null) {</span>
<span class="nc" id="L104">                payment.setAmount(appointment.getFee());</span>
<span class="nc" id="L105">                log.info(&quot;Using appointment fee: {} VND&quot;, appointment.getFee());</span>
            } else {
                // Fallback n·∫øu appointment kh√¥ng c√≥ fee
<span class="nc" id="L108">                payment.setAmount(paymentCreateDTO.getAmount());</span>
<span class="nc" id="L109">                log.warn(&quot;Appointment has no fee, using DTO amount: {}&quot;, paymentCreateDTO.getAmount());</span>
            }
            
<span class="nc bnc" id="L112" title="All 2 branches missed.">            payment.setDescription(paymentCreateDTO.getDescription() != null ? </span>
<span class="nc" id="L113">                paymentCreateDTO.getDescription() : &quot;Thanh to√°n l·ªãch h·∫πn kh√°m b·ªánh&quot;);</span>
<span class="nc" id="L114">            payment.setStatus(Payment.PaymentStatus.PENDING);</span>
            
            // L∆∞u payment tr∆∞·ªõc
<span class="nc" id="L117">            payment = paymentRepository.save(payment);</span>
            
            // T·∫°o PayOS payment link
<span class="nc" id="L120">            log.info(&quot;üîç Creating PayOS payment link for payment ID: {}&quot;, payment.getPaymentId());</span>
<span class="nc" id="L121">            payOSService.createPaymentLink(</span>
                payment,
<span class="nc" id="L123">                paymentCreateDTO.getReturnUrl(),</span>
<span class="nc" id="L124">                paymentCreateDTO.getCancelUrl()</span>
            );
            
            // C·∫≠p nh·∫≠t payment v·ªõi th√¥ng tin t·ª´ PayOS (ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω trong PayOSService)
            // PayOSService ƒë√£ handle vi·ªác set PayOS fields, ch·ªâ c·∫ßn log
<span class="nc" id="L129">            log.info(&quot;Payment created with PayOS integration for payment ID: {}&quot;, payment.getPaymentId());</span>
            
<span class="nc" id="L131">            payment = paymentRepository.save(payment);</span>
            
<span class="nc" id="L133">            log.info(&quot;Payment created successfully with ID: {}&quot;, payment.getPaymentId());</span>
<span class="nc" id="L134">            return paymentMapper.toResponseDTO(payment);</span>
            
<span class="nc" id="L136">        } catch (Exception e) {</span>
<span class="nc" id="L137">            log.error(&quot;Error creating payment: &quot;, e);</span>
<span class="nc" id="L138">            throw new RuntimeException(&quot;L·ªói khi t·∫°o thanh to√°n: &quot; + e.getMessage());</span>
        }
    }
    
    public PaymentDTO.Response getPaymentById(Long paymentId) {
<span class="nc" id="L143">        Optional&lt;Payment&gt; paymentOpt = paymentRepository.findById(paymentId);</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">        if (paymentOpt.isEmpty()) {</span>
<span class="nc" id="L145">            throw new RuntimeException(&quot;Kh√¥ng t√¨m th·∫•y thanh to√°n v·ªõi ID: &quot; + paymentId);</span>
        }
<span class="nc" id="L147">        return paymentMapper.toResponseDTO(paymentOpt.get());</span>
    }
    
    public PaymentDTO.Response getPaymentByPayOSPaymentId(String payOSPaymentId) {
<span class="nc" id="L151">        Optional&lt;Payment&gt; paymentOpt = paymentRepository.findByPayOSPaymentId(payOSPaymentId);</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">        if (paymentOpt.isEmpty()) {</span>
<span class="nc" id="L153">            throw new RuntimeException(&quot;Kh√¥ng t√¨m th·∫•y thanh to√°n v·ªõi PayOS Payment ID: &quot; + payOSPaymentId);</span>
        }
<span class="nc" id="L155">        return paymentMapper.toResponseDTO(paymentOpt.get());</span>
    }
    
    public List&lt;PaymentDTO.Response&gt; getPaymentsByAppointmentId(Long appointmentId) {
<span class="nc" id="L159">        List&lt;Payment&gt; payments = paymentRepository.findByAppointment_AppointmentId(appointmentId);</span>
<span class="nc" id="L160">        return payments.stream()</span>
<span class="nc" id="L161">                .map(paymentMapper::toResponseDTO)</span>
<span class="nc" id="L162">                .toList();</span>
    }
    
    public List&lt;PaymentDTO.Response&gt; getPaymentsByPatientId(Long patientId) {
<span class="nc" id="L166">        List&lt;Payment&gt; payments = paymentRepository.findByPatientId(patientId);</span>
<span class="nc" id="L167">        return payments.stream()</span>
<span class="nc" id="L168">                .map(paymentMapper::toResponseDTO)</span>
<span class="nc" id="L169">                .toList();</span>
    }
    
    public List&lt;PaymentDTO.Response&gt; getPaymentsByDoctorId(Long doctorId) {
<span class="nc" id="L173">        List&lt;Payment&gt; payments = paymentRepository.findByDoctorId(doctorId);</span>
<span class="nc" id="L174">        return payments.stream()</span>
<span class="nc" id="L175">                .map(paymentMapper::toResponseDTO)</span>
<span class="nc" id="L176">                .toList();</span>
    }
    
    public Page&lt;PaymentDTO.Response&gt; getAllPayments(Pageable pageable) {
<span class="nc" id="L180">        Page&lt;Payment&gt; payments = paymentRepository.findAll(pageable);</span>
<span class="nc" id="L181">        return payments.map(paymentMapper::toResponseDTO);</span>
    }
    
    public List&lt;PaymentDTO.Response&gt; getPaymentsByStatus(Payment.PaymentStatus status) {
<span class="nc" id="L185">        List&lt;Payment&gt; payments = paymentRepository.findByStatus(status);</span>
<span class="nc" id="L186">        return payments.stream()</span>
<span class="nc" id="L187">                .map(paymentMapper::toResponseDTO)</span>
<span class="nc" id="L188">                .toList();</span>
    }
    
    @Transactional
    public PaymentDTO.Response updatePaymentStatus(Long paymentId, Payment.PaymentStatus status) {
<span class="nc" id="L193">        Optional&lt;Payment&gt; paymentOpt = paymentRepository.findById(paymentId);</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">        if (paymentOpt.isEmpty()) {</span>
<span class="nc" id="L195">            throw new RuntimeException(&quot;Kh√¥ng t√¨m th·∫•y thanh to√°n v·ªõi ID: &quot; + paymentId);</span>
        }
        
<span class="nc" id="L198">        Payment payment = paymentOpt.get();</span>
<span class="nc" id="L199">        payment.setStatus(status);</span>
        
<span class="nc bnc" id="L201" title="All 2 branches missed.">        if (status == Payment.PaymentStatus.PAID) {</span>
<span class="nc" id="L202">            payment.setPaidAt(java.time.LocalDateTime.now());</span>
        }
        
<span class="nc" id="L205">        payment = paymentRepository.save(payment);</span>
<span class="nc" id="L206">        log.info(&quot;Payment status updated to {} for payment ID: {}&quot;, status, paymentId);</span>
        
<span class="nc" id="L208">        return paymentMapper.toResponseDTO(payment);</span>
    }
    
    @Transactional
    public PaymentDTO.Response updatePaymentStatusByPayOSPaymentId(String payOSPaymentId, Payment.PaymentStatus status) {
<span class="nc" id="L213">        Optional&lt;Payment&gt; paymentOpt = paymentRepository.findByPayOSPaymentId(payOSPaymentId);</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">        if (paymentOpt.isEmpty()) {</span>
<span class="nc" id="L215">            throw new RuntimeException(&quot;Kh√¥ng t√¨m th·∫•y thanh to√°n v·ªõi PayOS Payment ID: &quot; + payOSPaymentId);</span>
        }
        
<span class="nc" id="L218">        Payment payment = paymentOpt.get();</span>
<span class="nc" id="L219">        payment.setStatus(status);</span>
        
<span class="nc bnc" id="L221" title="All 2 branches missed.">        if (status == Payment.PaymentStatus.PAID) {</span>
<span class="nc" id="L222">            payment.setPaidAt(java.time.LocalDateTime.now());</span>
        }
        
<span class="nc" id="L225">        payment = paymentRepository.save(payment);</span>
<span class="nc" id="L226">        log.info(&quot;Payment status updated to {} for PayOS Payment ID: {}&quot;, status, payOSPaymentId);</span>
        
<span class="nc" id="L228">        return paymentMapper.toResponseDTO(payment);</span>
    }

    @Transactional
    public PaymentDTO.Response updatePaymentStatusFromPayOS(String payOSPaymentId, String status, String orderCode) {
<span class="nc" id="L233">        log.info(&quot;üîç Updating payment status from PayOS: payOSId={}, status={}, orderCode={}&quot;, </span>
            payOSPaymentId, status, orderCode);
        
        // T√¨m payment theo PayOS Payment ID
<span class="nc" id="L237">        Optional&lt;Payment&gt; paymentOpt = paymentRepository.findByPayOSPaymentId(payOSPaymentId);</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">        if (paymentOpt.isEmpty()) {</span>
<span class="nc" id="L239">            throw new RuntimeException(&quot;Kh√¥ng t√¨m th·∫•y thanh to√°n v·ªõi PayOS Payment ID: &quot; + payOSPaymentId);</span>
        }
        
<span class="nc" id="L242">        Payment payment = paymentOpt.get();</span>
        
        // C·∫≠p nh·∫≠t status
        Payment.PaymentStatus paymentStatus;
<span class="nc bnc" id="L246" title="All 4 branches missed.">        switch (status.toUpperCase()) {</span>
            case &quot;PAID&quot;:
<span class="nc" id="L248">                paymentStatus = Payment.PaymentStatus.PAID;</span>
<span class="nc" id="L249">                break;</span>
            case &quot;CANCELLED&quot;:
<span class="nc" id="L251">                paymentStatus = Payment.PaymentStatus.CANCELLED;</span>
<span class="nc" id="L252">                break;</span>
            case &quot;PENDING&quot;:
<span class="nc" id="L254">                paymentStatus = Payment.PaymentStatus.PENDING;</span>
<span class="nc" id="L255">                break;</span>
            default:
<span class="nc" id="L257">                paymentStatus = Payment.PaymentStatus.FAILED;</span>
                break;
        }
        
<span class="nc" id="L261">        payment.setStatus(paymentStatus);</span>
        
<span class="nc bnc" id="L263" title="All 2 branches missed.">        if (paymentStatus == Payment.PaymentStatus.PAID) {</span>
<span class="nc" id="L264">            payment.setPaidAt(java.time.LocalDateTime.now());</span>
        }
        
        // C·∫≠p nh·∫≠t orderCode n·∫øu c√≥
<span class="nc bnc" id="L268" title="All 4 branches missed.">        if (orderCode != null &amp;&amp; !orderCode.isEmpty()) {</span>
<span class="nc" id="L269">            payment.setPayOSCode(orderCode);</span>
        }
        
<span class="nc" id="L272">        payment = paymentRepository.save(payment);</span>
<span class="nc" id="L273">        log.info(&quot;‚úÖ Payment status updated to {} for PayOS Payment ID: {}&quot;, paymentStatus, payOSPaymentId);</span>
        
<span class="nc" id="L275">        return paymentMapper.toResponseDTO(payment);</span>
    }
    
    @Transactional
    public void deletePayment(Long paymentId) {
<span class="nc" id="L280">        Optional&lt;Payment&gt; paymentOpt = paymentRepository.findById(paymentId);</span>
<span class="nc bnc" id="L281" title="All 2 branches missed.">        if (paymentOpt.isEmpty()) {</span>
<span class="nc" id="L282">            throw new RuntimeException(&quot;Kh√¥ng t√¨m th·∫•y thanh to√°n v·ªõi ID: &quot; + paymentId);</span>
        }
        
<span class="nc" id="L285">        Payment payment = paymentOpt.get();</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">        if (payment.getStatus() == Payment.PaymentStatus.PAID) {</span>
<span class="nc" id="L287">            throw new RuntimeException(&quot;Kh√¥ng th·ªÉ x√≥a thanh to√°n ƒë√£ ho√†n th√†nh&quot;);</span>
        }
        
<span class="nc" id="L290">        paymentRepository.delete(payment);</span>
<span class="nc" id="L291">        log.info(&quot;Payment deleted with ID: {}&quot;, paymentId);</span>
<span class="nc" id="L292">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>
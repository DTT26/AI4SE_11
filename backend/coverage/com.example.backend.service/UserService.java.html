<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="vi"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UserService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">backend</a> &gt; <a href="index.source.html" class="el_package">com.example.backend.service</a> &gt; <span class="el_source">UserService.java</span></div><h1>UserService.java</h1><pre class="source lang-java linenums">package com.example.backend.service;

import java.util.List;
import java.util.Optional;

import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Propagation;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.multipart.MultipartFile;

import com.example.backend.exception.ConflictException;
import com.example.backend.exception.NotFoundException;
import com.example.backend.model.Role;
import com.example.backend.model.User;
import com.example.backend.repository.RoleRepository;
import com.example.backend.repository.UserRepository;
import com.example.backend.repository.DoctorRepository;
import com.example.backend.repository.PatientRepository;
import com.example.backend.model.Doctor;
import com.example.backend.model.Patient;
import com.example.backend.dto.UserWithPatientInfoDTO;

import lombok.RequiredArgsConstructor;

/**
 * Service class cho User entity
 * Chứa business logic để xử lý các thao tác CRUD với User
 */
@Service
@RequiredArgsConstructor
@Transactional
public class UserService {

    private final UserRepository userRepository;
    private final RoleRepository roleRepository;
    private final DoctorRepository doctorRepository;
    private final PatientRepository patientRepository;
    private final BCryptPasswordEncoder passwordEncoder;

    /**
     * Lấy tất cả user với thông tin role
     * @param pageable thông tin phân trang
     * @return danh sách user với phân trang
     */
    @Transactional(readOnly = true)
    public Page&lt;User&gt; getAllUsersWithRole(Pageable pageable) {
<span class="nc" id="L50">        return userRepository.findAllWithRole(pageable);</span>
    }

    /**
     * Lấy user theo ID với thông tin role
     * @param userId ID của user
     * @return user nếu tìm thấy
     * @throws NotFoundException nếu không tìm thấy user
     */
    @Transactional(readOnly = true)
    public User getUserByIdWithRole(Long userId) {
<span class="nc" id="L61">        return userRepository.findByIdWithRole(userId)</span>
<span class="nc" id="L62">                .orElseThrow(() -&gt; new NotFoundException(&quot;Không tìm thấy user với ID: &quot; + userId));</span>
    }

    /**
     * Lấy user theo email với thông tin role
     * @param email email của user
     * @return user nếu tìm thấy
     * @throws NotFoundException nếu không tìm thấy user
     */
    @Transactional(readOnly = true)
    public User getUserByEmailWithRole(String email) {
<span class="nc" id="L73">        return userRepository.findByEmailWithRole(email)</span>
<span class="nc" id="L74">                .orElseThrow(() -&gt; new NotFoundException(&quot;Không tìm thấy user với email: &quot; + email));</span>
    }

    /**
     * Tìm user với các bộ lọc
     * @param email email để tìm kiếm
     * @param firstName tên để tìm kiếm
     * @param lastName họ để tìm kiếm
     * @param status trạng thái để tìm kiếm
     * @param roleId ID role để tìm kiếm
     * @param pageable thông tin phân trang
     * @return danh sách user với phân trang
     */
    @Transactional(readOnly = true)
    public Page&lt;User&gt; searchUsersWithFilters(String email, String firstName, String lastName, 
                                           User.UserStatus status, Long roleId, Pageable pageable) {
<span class="nc" id="L90">        return userRepository.findUsersWithFilters(email, firstName, lastName, status, roleId, pageable);</span>
    }

    /**
     * Lấy tất cả user với thông tin role
     * @return danh sách user với thông tin role
     */
    @Transactional(readOnly = true)
    public List&lt;User&gt; getAllUsersWithRoleInfo() {
<span class="nc" id="L99">        return userRepository.findAllWithRoleInfo();</span>
    }

    /**
     * Lấy tất cả user với thông tin role và thông tin bệnh nhân (nếu có)
     * @return danh sách user với thông tin đầy đủ
     */
    @Transactional(readOnly = true)
    public List&lt;UserWithPatientInfoDTO&gt; getAllUsersWithPatientInfo() {
<span class="nc" id="L108">        List&lt;User&gt; users = userRepository.findAllWithRoleInfo();</span>
<span class="nc" id="L109">        return users.stream()</span>
<span class="nc" id="L110">                .map(this::convertToUserWithPatientInfoDTO)</span>
<span class="nc" id="L111">                .toList();</span>
    }

    /**
     * Tìm user theo roleId với thông tin role
     * @param roleId ID của role
     * @return danh sách user theo role
     */
    @Transactional(readOnly = true)
    public List&lt;User&gt; getUsersByRoleIdWithRoleInfo(Long roleId) {
<span class="nc" id="L121">        return userRepository.findByRoleIdWithRoleInfo(roleId);</span>
    }

    /**
     * Tìm user theo tên với thông tin role
     * @param keyword từ khóa tìm kiếm
     * @return danh sách user theo tên
     */
    @Transactional(readOnly = true)
    public List&lt;User&gt; getUsersByNameWithRoleInfo(String keyword) {
<span class="nc" id="L131">        return userRepository.findByNameContainingWithRoleInfo(keyword);</span>
    }

    /**
     * Tạo user mới
     * @param email email của user
     * @param passwordHash hash của password
     * @param firstName tên
     * @param lastName họ
     * @param phone số điện thoại
     * @param gender giới tính
     * @param dateOfBirth ngày sinh
     * @param address địa chỉ
     * @param roleId ID của role
     * @return user đã được tạo
     * @throws ConflictException nếu email đã tồn tại
     * @throws NotFoundException nếu không tìm thấy role hoặc roleId null
     */
    public User createUser(String email, String passwordHash, String firstName, String lastName, 
                          String phone, User.Gender gender, java.time.LocalDate dateOfBirth, 
                          String address, String avatarUrl, Long roleId) {
        
        // Kiểm tra email đã tồn tại chưa
<span class="nc bnc" id="L154" title="All 2 branches missed.">        if (userRepository.existsByEmail(email)) {</span>
<span class="nc" id="L155">            throw new ConflictException(&quot;Email đã tồn tại: &quot; + email);</span>
        }

        // Kiểm tra roleId không null
<span class="nc bnc" id="L159" title="All 2 branches missed.">        if (roleId == null) {</span>
<span class="nc" id="L160">            throw new IllegalArgumentException(&quot;RoleId không được để trống&quot;);</span>
        }

        // Kiểm tra role tồn tại
<span class="nc" id="L164">        Role role = roleRepository.findById(roleId)</span>
<span class="nc" id="L165">                .orElseThrow(() -&gt; new NotFoundException(&quot;Không tìm thấy role với ID: &quot; + roleId));</span>

        // Tạo user mới
<span class="nc" id="L168">        User user = new User();</span>
<span class="nc" id="L169">        user.setEmail(email);</span>
        
        // Hash password trước khi lưu
<span class="nc" id="L172">        String hashedPassword = passwordEncoder.encode(passwordHash);</span>
<span class="nc" id="L173">        user.setPasswordHash(hashedPassword);</span>
<span class="nc" id="L174">        user.setFirstName(firstName);</span>
<span class="nc" id="L175">        user.setLastName(lastName);</span>
<span class="nc" id="L176">        user.setPhone(phone);</span>
<span class="nc" id="L177">        user.setGender(gender);</span>
<span class="nc" id="L178">        user.setDateOfBirth(dateOfBirth);</span>
<span class="nc" id="L179">        user.setAddress(address);</span>
<span class="nc" id="L180">        user.setAvatarUrl(avatarUrl);</span>
<span class="nc" id="L181">        user.setRole(role);</span>
<span class="nc" id="L182">        user.setStatus(User.UserStatus.ACTIVE);</span>

<span class="nc" id="L184">        User savedUser = userRepository.save(user);</span>

<span class="nc" id="L186">        return savedUser;</span>
    }

    /**
     * Cập nhật thông tin user
     * @param userId ID của user
     * @param email email mới
     * @param firstName tên mới
     * @param lastName họ mới
     * @param phone số điện thoại mới
     * @param gender giới tính mới
     * @param dateOfBirth ngày sinh mới
     * @param address địa chỉ mới
     * @param status trạng thái mới
     * @param roleId ID role mới
     * @return user đã được cập nhật
     * @throws NotFoundException nếu không tìm thấy user hoặc role
     * @throws ConflictException nếu email mới đã tồn tại
     */
    public User updateUser(Long userId, String email, String passwordHash, String firstName, String lastName, 
                          String phone, User.Gender gender, java.time.LocalDate dateOfBirth, 
                          String address, String avatarUrl, User.UserStatus status, Long roleId) {
        
<span class="nc" id="L209">        User user = userRepository.findById(userId)</span>
<span class="nc" id="L210">                .orElseThrow(() -&gt; new NotFoundException(&quot;Không tìm thấy user với ID: &quot; + userId));</span>

        // Kiểm tra email mới có trùng với user khác không (nếu có)
<span class="nc bnc" id="L213" title="All 4 branches missed.">        if (email != null &amp;&amp; !email.equals(user.getEmail())) {</span>
            // Kiểm tra xem email có tồn tại với user khác không
<span class="nc" id="L215">            Optional&lt;User&gt; existingUser = userRepository.findByEmailWithRole(email);</span>
<span class="nc bnc" id="L216" title="All 4 branches missed.">            if (existingUser.isPresent() &amp;&amp; !existingUser.get().getId().equals(userId)) {</span>
<span class="nc" id="L217">                throw new ConflictException(&quot;Email đã tồn tại: &quot; + email);</span>
            }
<span class="nc" id="L219">            user.setEmail(email);</span>
        }

        // Cập nhật password nếu có
<span class="nc bnc" id="L223" title="All 4 branches missed.">        if (passwordHash != null &amp;&amp; !passwordHash.trim().isEmpty()) {</span>
<span class="nc" id="L224">            String hashedPassword = passwordEncoder.encode(passwordHash);</span>
<span class="nc" id="L225">            user.setPasswordHash(hashedPassword);</span>
        }

        // Kiểm tra role mới tồn tại (nếu có)
<span class="nc bnc" id="L229" title="All 2 branches missed.">        if (roleId != null) {</span>
            try {
<span class="nc bnc" id="L231" title="All 2 branches missed.">                Long currentRoleId = (user.getRole() != null) ? user.getRole().getId() : null;</span>
<span class="nc bnc" id="L232" title="All 4 branches missed.">                if (currentRoleId == null || !currentRoleId.equals(roleId)) {</span>
<span class="nc" id="L233">                    Role role = roleRepository.findById(roleId)</span>
<span class="nc" id="L234">                            .orElseThrow(() -&gt; new NotFoundException(&quot;Không tìm thấy role với ID: &quot; + roleId));</span>
<span class="nc" id="L235">                    user.setRole(role);</span>
                }
<span class="nc" id="L237">            } catch (Exception e) {</span>
                // Nếu có lỗi với Hibernate proxy, tìm lại user
<span class="nc" id="L239">                user = userRepository.findById(userId)</span>
<span class="nc" id="L240">                        .orElseThrow(() -&gt; new NotFoundException(&quot;Không tìm thấy user với ID: &quot; + userId));</span>
<span class="nc" id="L241">                Role role = roleRepository.findById(roleId)</span>
<span class="nc" id="L242">                        .orElseThrow(() -&gt; new NotFoundException(&quot;Không tìm thấy role với ID: &quot; + roleId));</span>
<span class="nc" id="L243">                user.setRole(role);</span>
<span class="nc" id="L244">            }</span>
        }

<span class="nc bnc" id="L247" title="All 2 branches missed.">        if (firstName != null) {</span>
<span class="nc" id="L248">            user.setFirstName(firstName);</span>
        }
<span class="nc bnc" id="L250" title="All 2 branches missed.">        if (lastName != null) {</span>
<span class="nc" id="L251">            user.setLastName(lastName);</span>
        }
<span class="nc bnc" id="L253" title="All 2 branches missed.">        if (phone != null) {</span>
<span class="nc" id="L254">            user.setPhone(phone);</span>
        }
<span class="nc bnc" id="L256" title="All 2 branches missed.">        if (gender != null) {</span>
<span class="nc" id="L257">            user.setGender(gender);</span>
        }
<span class="nc bnc" id="L259" title="All 2 branches missed.">        if (dateOfBirth != null) {</span>
<span class="nc" id="L260">            user.setDateOfBirth(dateOfBirth);</span>
        }
<span class="nc bnc" id="L262" title="All 4 branches missed.">        if (address != null &amp;&amp; !address.trim().isEmpty()) {</span>
<span class="nc" id="L263">            System.out.println(&quot;Updating user address: &quot; + address);</span>
<span class="nc" id="L264">            user.setAddress(address.trim());</span>
        } else {
<span class="nc" id="L266">            System.out.println(&quot;Address is null or empty, not updating&quot;);</span>
        }
<span class="nc bnc" id="L268" title="All 2 branches missed.">        if (avatarUrl != null) {</span>
<span class="nc" id="L269">            user.setAvatarUrl(avatarUrl);</span>
        }
<span class="nc bnc" id="L271" title="All 2 branches missed.">        if (status != null) {</span>
<span class="nc" id="L272">            user.setStatus(status);</span>
        }

        try {
<span class="nc" id="L276">            return userRepository.save(user);</span>
<span class="nc" id="L277">        } catch (Exception e) {</span>
<span class="nc" id="L278">            System.err.println(&quot;Error saving user: &quot; + e.getMessage());</span>
<span class="nc" id="L279">            e.printStackTrace();</span>
<span class="nc" id="L280">            throw e;</span>
        }
    }

    /**
     * Xóa user (soft delete)
     * @param userId ID của user
     * @throws NotFoundException nếu không tìm thấy user
     */
    public void deleteUser(Long userId) {
<span class="nc" id="L290">        User user = userRepository.findById(userId)</span>
<span class="nc" id="L291">                .orElseThrow(() -&gt; new NotFoundException(&quot;Không tìm thấy user với ID: &quot; + userId));</span>

<span class="nc" id="L293">        user.setStatus(User.UserStatus.DELETED);</span>
<span class="nc" id="L294">        userRepository.save(user);</span>
<span class="nc" id="L295">    }</span>

    /**
     * Xóa user vĩnh viễn (hard delete)
     * @param userId ID của user
     * @throws NotFoundException nếu không tìm thấy user
     */
    public void hardDeleteUser(Long userId) {
<span class="nc bnc" id="L303" title="All 2 branches missed.">        if (!userRepository.existsById(userId)) {</span>
<span class="nc" id="L304">            throw new NotFoundException(&quot;Không tìm thấy user với ID: &quot; + userId);</span>
        }
<span class="nc" id="L306">        userRepository.deleteById(userId);</span>
<span class="nc" id="L307">    }</span>

    /**
     * Đếm số user theo roleId
     * @param roleId ID của role
     * @return số lượng user
     */
    @Transactional(readOnly = true)
    public long countUsersByRoleId(Long roleId) {
<span class="nc" id="L316">        return userRepository.countByRoleId(roleId);</span>
    }

    /**
     * Kiểm tra email đã tồn tại chưa
     * @param email email cần kiểm tra
     * @return true nếu email đã tồn tại
     */
    @Transactional(readOnly = true)
    public boolean isEmailExists(String email) {
<span class="nc" id="L326">        return userRepository.existsByEmail(email);</span>
    }

    /**
     * Tạo doctor record trong transaction riêng
     * @param userId ID của user
     */
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void createDoctorRecordAsync(Long userId) {
        try {
<span class="nc" id="L336">            Doctor doctor = new Doctor();</span>
<span class="nc" id="L337">            doctor.setDoctorId(userId);</span>
<span class="nc" id="L338">            doctor.setBio(&quot;Bác sĩ chuyên khoa&quot;);</span>
<span class="nc" id="L339">            doctor.setSpecialty(&quot;Nội khoa&quot;);</span>
            // Status is managed by User entity, not Doctor entity
            // Không set departmentId vì có thể gây lỗi constraint
            
<span class="nc" id="L343">            doctorRepository.save(doctor);</span>
<span class="nc" id="L344">            System.out.println(&quot;Đã tạo doctor record cho userId: &quot; + userId);</span>
<span class="nc" id="L345">        } catch (Exception e) {</span>
<span class="nc" id="L346">            System.err.println(&quot;Lỗi khi tạo doctor record: &quot; + e.getMessage());</span>
<span class="nc" id="L347">        }</span>
<span class="nc" id="L348">    }</span>

    /**
     * Tạo patient record trong transaction riêng
     * @param userId ID của user
     */
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void createPatientRecordAsync(Long userId) {
        try {
<span class="nc" id="L357">            User user = userRepository.findById(userId).orElse(null);</span>
<span class="nc bnc" id="L358" title="All 2 branches missed.">            if (user == null) return;</span>
            
<span class="nc" id="L360">            Patient patient = new Patient();</span>
<span class="nc" id="L361">            patient.setPatientId(userId);</span>
<span class="nc" id="L362">            patient.setUser(user);</span>
<span class="nc" id="L363">            patient.setHealthInsuranceNumber(null);</span>
<span class="nc" id="L364">            patient.setMedicalHistory(null);</span>
            
<span class="nc" id="L366">            patientRepository.save(patient);</span>
<span class="nc" id="L367">            System.out.println(&quot;Đã tạo patient record cho userId: &quot; + userId);</span>
<span class="nc" id="L368">        } catch (Exception e) {</span>
<span class="nc" id="L369">            System.err.println(&quot;Lỗi khi tạo patient record: &quot; + e.getMessage());</span>
<span class="nc" id="L370">        }</span>
<span class="nc" id="L371">    }</span>

    /**
     * Convert User entity thành UserWithPatientInfoDTO
     * @param user User entity
     * @return UserWithPatientInfoDTO
     */
    private UserWithPatientInfoDTO convertToUserWithPatientInfoDTO(User user) {
<span class="nc" id="L379">        UserWithPatientInfoDTO dto = new UserWithPatientInfoDTO();</span>
        
        // Copy thông tin cơ bản từ User
<span class="nc" id="L382">        dto.setId(user.getId());</span>
<span class="nc" id="L383">        dto.setEmail(user.getEmail());</span>
<span class="nc" id="L384">        dto.setFirstName(user.getFirstName());</span>
<span class="nc" id="L385">        dto.setLastName(user.getLastName());</span>
<span class="nc" id="L386">        dto.setPhone(user.getPhone());</span>
<span class="nc bnc" id="L387" title="All 2 branches missed.">        dto.setGender(user.getGender() != null ? user.getGender().name() : null);</span>
<span class="nc" id="L388">        dto.setDateOfBirth(user.getDateOfBirth());</span>
<span class="nc" id="L389">        dto.setAddress(user.getAddress());</span>
<span class="nc" id="L390">        dto.setAvatarUrl(user.getAvatarUrl());</span>
<span class="nc" id="L391">        dto.setCreatedAt(user.getCreatedAt());</span>
<span class="nc bnc" id="L392" title="All 2 branches missed.">        dto.setStatus(user.getStatus() != null ? user.getStatus().name() : null);</span>
        
        // Copy thông tin Role
<span class="nc bnc" id="L395" title="All 2 branches missed.">        if (user.getRole() != null) {</span>
<span class="nc" id="L396">            UserWithPatientInfoDTO.RoleDTO roleDTO = new UserWithPatientInfoDTO.RoleDTO();</span>
<span class="nc" id="L397">            roleDTO.setId(user.getRole().getId());</span>
<span class="nc" id="L398">            roleDTO.setName(user.getRole().getName());</span>
<span class="nc" id="L399">            roleDTO.setDescription(user.getRole().getDescription());</span>
<span class="nc" id="L400">            dto.setRole(roleDTO);</span>
        }
        
        // Nếu user là Patient, lấy thông tin bệnh nhân
<span class="nc bnc" id="L404" title="All 4 branches missed.">        if (user.getRole() != null &amp;&amp; &quot;PATIENT&quot;.equals(user.getRole().getName())) {</span>
            try {
<span class="nc" id="L406">                Optional&lt;Patient&gt; patientOpt = patientRepository.findByPatientId(user.getId());</span>
<span class="nc bnc" id="L407" title="All 2 branches missed.">                if (patientOpt.isPresent()) {</span>
<span class="nc" id="L408">                    Patient patient = patientOpt.get();</span>
<span class="nc" id="L409">                    dto.setHealthInsuranceNumber(patient.getHealthInsuranceNumber());</span>
<span class="nc" id="L410">                    dto.setMedicalHistory(patient.getMedicalHistory());</span>
<span class="nc" id="L411">                    dto.setPatientCreatedAt(patient.getCreatedAt());</span>
<span class="nc" id="L412">                    dto.setPatientStatus(patient.getStatus());</span>
                }
<span class="nc" id="L414">            } catch (Exception e) {</span>
                // Nếu không tìm thấy thông tin patient, để null
<span class="nc" id="L416">                System.err.println(&quot;Không tìm thấy thông tin patient cho user ID: &quot; + user.getId());</span>
<span class="nc" id="L417">            }</span>
        }
        
        // Nếu user là Doctor, lấy thông tin bác sĩ
<span class="nc bnc" id="L421" title="All 4 branches missed.">        if (user.getRole() != null &amp;&amp; &quot;DOCTOR&quot;.equals(user.getRole().getName())) {</span>
            try {
<span class="nc" id="L423">                Optional&lt;Doctor&gt; doctorOpt = doctorRepository.findByDoctorId(user.getId());</span>
<span class="nc bnc" id="L424" title="All 2 branches missed.">                if (doctorOpt.isPresent()) {</span>
<span class="nc" id="L425">                    Doctor doctor = doctorOpt.get();</span>
<span class="nc" id="L426">                    dto.setBio(doctor.getBio());</span>
<span class="nc" id="L427">                    dto.setSpecialty(doctor.getSpecialty());</span>
<span class="nc bnc" id="L428" title="All 2 branches missed.">                    dto.setDepartmentId(doctor.getDepartment() != null ? doctor.getDepartment().getId() : null);</span>
<span class="nc bnc" id="L429" title="All 2 branches missed.">                    dto.setDepartmentName(doctor.getDepartment() != null ? doctor.getDepartment().getDepartmentName() : null);</span>
<span class="nc" id="L430">                    dto.setDoctorStatus(doctor.getStatus());</span>
                }
<span class="nc" id="L432">            } catch (Exception e) {</span>
                // Nếu không tìm thấy thông tin doctor, để null
<span class="nc" id="L434">                System.err.println(&quot;Không tìm thấy thông tin doctor cho user ID: &quot; + user.getId());</span>
<span class="nc" id="L435">            }</span>
        }
        
        // Nếu user là Admin, lấy thông tin quản trị viên
<span class="nc bnc" id="L439" title="All 4 branches missed.">        if (user.getRole() != null &amp;&amp; &quot;ADMIN&quot;.equals(user.getRole().getName())) {</span>
            // Tạm thời set thông tin mặc định cho admin
<span class="nc" id="L441">            dto.setAdminLevel(&quot;Super Admin&quot;);</span>
<span class="nc" id="L442">            dto.setAdminPermissions(&quot;Full Access&quot;);</span>
<span class="nc" id="L443">            dto.setAdminNotes(&quot;Quản trị viên hệ thống&quot;);</span>
        }
        
<span class="nc" id="L446">        return dto;</span>
    }

    /**
     * Upload ảnh đại diện cho user
     * @param userId ID của user
     * @param file file ảnh
     * @return URL của ảnh đã upload
     */
    public String uploadAvatar(Long userId, MultipartFile file) {
        try {
<span class="nc" id="L457">            User user = getUserByIdWithRole(userId);</span>
            
            // Validate file
<span class="nc bnc" id="L460" title="All 2 branches missed.">            if (file.isEmpty()) {</span>
<span class="nc" id="L461">                throw new RuntimeException(&quot;File không được để trống&quot;);</span>
            }
            
            // Check file size (5MB limit)
<span class="nc bnc" id="L465" title="All 2 branches missed.">            if (file.getSize() &gt; 5 * 1024 * 1024) {</span>
<span class="nc" id="L466">                throw new RuntimeException(&quot;Kích thước file không được vượt quá 5MB&quot;);</span>
            }
            
            // Check file type
<span class="nc" id="L470">            String contentType = file.getContentType();</span>
<span class="nc bnc" id="L471" title="All 4 branches missed.">            if (contentType == null || !contentType.startsWith(&quot;image/&quot;)) {</span>
<span class="nc" id="L472">                throw new RuntimeException(&quot;File phải là ảnh&quot;);</span>
            }
            
            // Generate unique filename
<span class="nc" id="L476">            String originalFilename = file.getOriginalFilename();</span>
<span class="nc bnc" id="L477" title="All 4 branches missed.">            if (originalFilename == null || originalFilename.isEmpty()) {</span>
<span class="nc" id="L478">                throw new RuntimeException(&quot;Tên file không hợp lệ&quot;);</span>
            }
<span class="nc" id="L480">            String extension = originalFilename.substring(originalFilename.lastIndexOf(&quot;.&quot;));</span>
<span class="nc" id="L481">            String filename = &quot;user_&quot; + userId + &quot;_&quot; + System.currentTimeMillis() + extension;</span>
            
            // Save file to uploads directory
<span class="nc" id="L484">            String uploadDir = &quot;uploads/&quot;;</span>
<span class="nc" id="L485">            java.nio.file.Path uploadPath = java.nio.file.Paths.get(uploadDir);</span>
<span class="nc bnc" id="L486" title="All 2 branches missed.">            if (!java.nio.file.Files.exists(uploadPath)) {</span>
<span class="nc" id="L487">                java.nio.file.Files.createDirectories(uploadPath);</span>
            }
            
<span class="nc" id="L490">            java.nio.file.Path filePath = uploadPath.resolve(filename);</span>
<span class="nc" id="L491">            java.nio.file.Files.copy(file.getInputStream(), filePath, java.nio.file.StandardCopyOption.REPLACE_EXISTING);</span>
            
            // Update user avatar
<span class="nc" id="L494">            String avatarUrl = &quot;/uploads/&quot; + filename;</span>
<span class="nc" id="L495">            user.setAvatarUrl(avatarUrl);</span>
<span class="nc" id="L496">            userRepository.save(user);</span>
            
<span class="nc" id="L498">            System.out.println(&quot;✅ Avatar uploaded successfully: &quot; + avatarUrl);</span>
<span class="nc" id="L499">            return avatarUrl;</span>
            
<span class="nc" id="L501">        } catch (Exception e) {</span>
<span class="nc" id="L502">            System.err.println(&quot;❌ Error uploading avatar: &quot; + e.getMessage());</span>
<span class="nc" id="L503">            throw new RuntimeException(&quot;Lỗi khi upload ảnh: &quot; + e.getMessage());</span>
        }
    }
    
    /**
     * Lấy user hiện tại từ token (simplified implementation)
     * @param token JWT token
     * @return User object
     */
    public User getCurrentUserFromToken(String token) {
        try {
            // For Google users, get the most recent Google user
<span class="nc" id="L515">            List&lt;User&gt; googleUsers = userRepository.findByPasswordHash(&quot;oauth_google_user&quot;);</span>
<span class="nc bnc" id="L516" title="All 2 branches missed.">            if (!googleUsers.isEmpty()) {</span>
                // Return the most recent Google user (highest ID)
<span class="nc" id="L518">                return googleUsers.stream()</span>
<span class="nc" id="L519">                    .max((u1, u2) -&gt; Long.compare(u1.getId(), u2.getId()))</span>
<span class="nc" id="L520">                    .orElse(null);</span>
            }
<span class="nc" id="L522">            return null;</span>
<span class="nc" id="L523">        } catch (Exception e) {</span>
<span class="nc" id="L524">            throw new RuntimeException(&quot;Failed to get current user from token&quot;, e);</span>
        }
    }

    /**
     * So sánh password thô với password đã hash
     * @param rawPassword password thô
     * @param encodedPassword password đã hash
     * @return true nếu khớp, false nếu không khớp
     */
    public boolean matchesPassword(String rawPassword, String encodedPassword) {
<span class="nc" id="L535">        return passwordEncoder.matches(rawPassword, encodedPassword);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>